<!DOCTYPE html>
{% load static from staticfiles %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <link rel="stylesheet" type="text/css" href="{% static 'mainInterface.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'msgbox.css'%}">
    <link rel="stylesheet" type="text/css" href="{% static request.session.themeCSS %}">
</head>

<script src="https://www.gstatic.com/firebasejs/5.8.6/firebase.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="{% static 'config.js'%}"></script>
<script src="{% static 'pchat.js'%}"></script>
<script>
// Initialize Firebase
var config = getConfig();
firebase.initializeApp(config);
var db = firebase.database();
function pushmsg()
{
  var msg = document.getElementById("message").value;
  document.getElementById("message").value = "";
  var user = "{{request.session.username}}";
  var t = new Date().getTime();
  var msgKey = user+t;
  db.ref('ConversationData/'+"{{request.session.currconv}}"+'/'+msgKey).set(
    {
      sender: "{{request.session.username}}",
      timeStamp: t,
      type: 0,
      data: msg
    }
  );
}
var msgarea = document.getElementById('chatbox');

function renderMSG(data)
{
  var $resDiv = $("")
  newdiv = document.createElement('div');
  newdiv.id = data.sender;
  alert("");
  msgarea.appendChild(newdiv);
  alert(data.data);
}
var convRef = db.ref('ConversationData/'+"{{request.session.currconv}}"+'/');
convRef.on('value', function(snapshot){
  //var convData =snapshot.val();
  //var keyArr= Object.keys(snapshot.val());
  //keyArr.forEach(function(k){renderMSG(convData[k]));
  $('.chatbox').html('').load('{% url "msgbox" %}');
});
</script>

<body onload='init()'>
  <script src="{% static 'mainInterface.js'%}"></script>
  <div class = "mainpane">
    <form action="settings.html" id="settings">
      <input type="submit" value = "Settings"></input>
    </form>
    <form action="appInterface.html" id="return">
        <input type="submit" value = "Back to Home Page"></input>
    </form>
    <form action="login.html" id="logout">
      <input type="submit" value="Logout"></input>
    </form>
</div>
<div id = "conversations" style="height: 400px; overflow-y: scroll">
  <div id = "chatInfo">
    <b style="border: 2px solid black;">Title: {{request.session.convTitle}}</b>
    <br />
    <b style="border:2px solid black;">Recipient:
      {% for c in request.session.convRecip %}
        {{c}} <span> , </span>
      {%endfor%}
    </b>
  </div>
  <div class="chatbox">
    {% include 'msgbox.html' %}
  </div>
  <p>
    <textarea id ="message" name="message"
    rows="6" cols="30" placeholder="Type a message here"></textarea>
  </p>
  <p>
    <input type = "submit" value="Send" onclick="pushmsg()"/>
  </p>
</div>

<canvas id="canvas" height="200" width="200" style="border:1px solid #000000;"></canvas>
</body>
</html>
